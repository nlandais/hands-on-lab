---
- hosts: localhost
  gather_facts: no
  vars:
    inventory_tag: '{{ tag | regex_replace("\.", "_") }}'
    setMachineKeys: yes
  pre_tasks:
    - include: roles/common/tasks/init.yml
    - file: src='{{ playbook_dir }}/group_vars/windows.yml' state=link dest='{{ playbook_dir }}/group_vars/tag_Name_{{ inventory_tag }}.yml' force=yes
  roles:
    - ec2-provision

- hosts: windows
  gather_facts: yes
  vars_files:
    - './roles/common/vars/{{ location }}.yml'
    - './roles/common/vars/defaults.yml'
    - './roles/create_site/vars/{{ target_environment }}/main.yml'
    - './roles/splunk/vars/keys.yml'

  roles:
    - role: basic_config
    - { role: create_site, site: web }

# See http://54.165.232.145/view/Deployment%20jobs/job/provision_instance/ to see how this playbook is called and used in the AWS environment
# From the command prompt on the Ansible run:
# Ansible-playbook webserver.yml -e 'target_environment=stage tag=webapp_release_16.5.1_107_stage_ami region=east location=AWS' --vault-password-file <path to vault key>
